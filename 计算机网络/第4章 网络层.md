### 网络层提供的两种服务

| 特性         | 数据报服务               | 虚电路服务             |
| ------------ | ------------------------ | ---------------------- |
| 连接方式     | 无连接                   | 面向连接               |
| 分组转发依据 | 完整 IP 地址             | 虚电路标识符（VCI）    |
| 路由方式     | 每个分组独立选路         | 所有分组沿同一路径转发 |
| 交付可靠性   | 尽最大努力交付（不可靠） | 有序、可靠交付         |
| 传输时延     | 小（无连接建立时间）     | 大（需建立连接）       |
| 适用协议     | IP 协议（互联网）        | X.25、帧中继、ATM      |

# IP地址

由网络号和主机号组成

### 分类的IP地址

1. A类8：0xxx
2. B类16：10xxx
3. C类24：110xxx
4. D类：1110+多播地址
5. E类1111+保留为今后使用

### CIDR

使用网络前缀代替网络号，用斜线记法表示

不能仅用128.14.32.0来指明一个网络地址，因为无法知道网络前缀是多少

全0表示网络地址用来标识整个子网，全1是直接广播地址，向子网内所有主机广播



分类IP地址划分子网时不使用全0和全1的子网，但是CIDR可以使用全0和全1的子网

### 子网掩码

CIDR使用斜线记法可以让我们知道网络前缀的数值，但是计算机看不见斜线记法，使用子网掩码能够从IP地址迅速算出网络地址

### IP地址的特点

1. 每个IP地址都由网络前缀和主机号两部分组成，从这个意义上说，IP地址是分等级的地址结构。**方便IP地址的管理，路由器根据目的主机所连接的网络前缀（地址块）来转发分组**。
2. IP地址是**标志一台主机（或路由器） 和一条链路的接口**。当一台主机同时连接两个网络时，该主机就必须同时具有两个相应的IP地址，其网络前缀必须是不同的。
3. 用转发器或交换机连接起来的若干个局域网仍为一个网络，因为这些局域网都**具有同样的网络前缀**。具有不同网络前缀的局域网必须使用**路由器**进行互连
4. 所有分配到网络前缀的网络都是平等的，互联网同等对待每个IP地址

路由器总是**具有两个或多个IP地址**，即路由器每个接口的IP地址的网络前缀都不同



### ARP协议工作原理

**ARP用于解决同一个局域网上的主机或路由器的IP地址和MAC地址的映射问题**

原理：在主机的ARP高速缓存中存放一个从IP地址到MAC地址的映射表，并且这个映射表还经常动态更新

例如A向B发送IP数据报

1. ARP进程在本局域网发送一个ARP请求分组，并将自己IP地址到MAC地址的映射写入请求分组中
2. 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组 
3.  B的IP地址域ARP请求分组中要查询的IP地址一致，收下这个请求分组并向A发送ARP响应分组，同时在这个ARP响应分组中写入自己的MAC地址。其他主机忽略这个请求分组
4. A收到响应分组后，在其ARP高速缓存中写入B的IP地址到MAC地址的映射

同时每一个映射地址项目设有生存周期，超时自动删除

### IP分组转发的算法

通过对目的地址与当前网络的子网掩码进行and运算，如果运算结果等于当前网络的前缀，那么说明目的地址在本网络上，直接交付即可，否则交给路由器根据转发表处理分组



# 内部网关协议RIP

RIP的中文译名是路由信息协议，是一种**分布式的基于距离向量的路由选择协议**。

### RIP协议的工作原理

从一路由器到直接连接的网络的距离定义为1，从一主机到非直接连接的网络的距离定义为所经过的路由器+1

RIP认为好的路由就是它通过的网络数目少，RIP允许一条路径最多只能包含15个网络，因此距离等于16时相当于不可达，可见RIP只适用于小型互联网

### 特点

1. 仅和相邻路由器交换信息
2. 交换的信息是自己现在的路由表
3. 按固定的时间间隔交换路由信息

### 距离向量算法

**好消息传播快，坏消息传播慢**

两个相邻的R1和R2，R1可与n1直接交付（n1,1,直接），但中间的链路突然出现故障，变为（n1,16,直接）,但是R2的表还是（n1,2,R1），并且已经将这个表传给R1，R1以为可以通过R2到n1，变为（n1,3,R2），然后R2变为（n1,4,R1)一直传传传，直到增大到16

为了让坏消息传播快些，可以让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送



# 内部网关协议OSPF

**链路状态协议**

### 特点

1. 向本自治系统中**所有路由器**发送信息（洪范法），而每一个相邻的路由器又再向其所有的相邻路由器发送信息，最终整个区域中所有的路由器都得到了这一信息的一个副本。注意**协议RIP仅仅向自己相邻的几个路由器发送信息**（RIP的每个路由器不知道全网的拓扑结构，而OSPF的知道）
2. 发送的信息是与本路由器**相邻的所有路由器的链路状态**
3. 当链路状态发送变化或每隔一段时间，路由器向所有路由器用洪范法发送链路状态信息
4. 更新过程收敛速度快

# BGP路由

**路径向量路由选择协议**

### eBGP

两个边界路由器进行通信，例如

R1可通过eBGP向对等端R2发送BGP路由“X,AS1,R1“，意思是从R1经AS1可到达X，这样，通过eBGP连接，AS2中的边界路由器R2就知道了到达AS1中的前缀X的BGP路由

### iBGP

仅有边界路由器R2知道上面的信息是不够的，R2应把获得的BGP路由再转发给AS内部的其他路由器。

为此，协议BGP规定，再AS内部，两个路由器之间还需要建立iBGP

协议BGP规定，在一个AS内部所有的iBGP必须是连通的，即使两个路由器之间没有物理连接，但他们之间仍然有iBGP连接